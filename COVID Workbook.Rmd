---
title: "COVID Database Workbook"
author: "Matthew Worthington, M.Ed., M.PAff."
date: "4/1/2020"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 
```{r message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(gghighlight)
library(janitor)
library(geofacet)
library(tinter)
library(highcharter)
library(texas2036)
library(fredr)
library(readxl)
library(grid)
library(sf)
library(ggthemes)
library(ggforce)
library(ggrepel)
library(ggtext)
library(gghighlight)
library(hrbrthemes)
fredr_set_key("22c6ffaa111781ee88df344a4f120eef")
```

# COVID Data

## Get State and Pop Data From Tidycensus

```{r}
library(tidyverse)
library(tidycensus)
readRenviron("~/.Renviron")
census_api_key <- Sys.getenv("CENSUS_API_KEY")
# census_api_key(key=census_api_key, install=TRUE, overwrite = TRUE)

tx_county_pop <- get_acs(geography="county", survey="acs5", 
                         variables = "B01003_001", state="TX", 
                         year=2018, geometry = TRUE) %>% 
                 select(-moe,-variable)
      
write_rds(tx_county_pop, "county_pop.rds")

tx_pop <- get_acs(geography="state", survey="acs5", 
                  variables = "B01003_001",
                  year=2018, show_call = TRUE) %>% 
          select(-moe,-variable)

write_rds(tx_pop, "state_pop.rds")

tigris_cntys <- tigris::counties(state="48", cb = TRUE) %>% 
  as_tibble() %>% 
  select(GEOID,county=NAME)

tx_counties <- tidycensus::county_laea %>% 
  filter(str_detect(GEOID, "^48")) %>% 
  left_join(tigris_cntys, by="GEOID") %>% 
  st_as_sf() %>% 
  st_transform(crs="+init=epsg:4326")





```

## JHU & COVID Tracking Data Files

```{r, macro_covid_data}

# Read In JHU Global Country Time Series Data
who_global_ts <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/who_covid_19_situation_reports/who_covid_19_sit_rep_time_series/who_covid_19_sit_rep_time_series.csv")

# Read In JHU Cases By Country
jhu_cases_country <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/web-data/data/cases_country.csv") %>% 
  clean_names()

# Read In JHU Cases By State
jhu_cases_state <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/web-data/data/cases_state.csv") %>% 
  clean_names()

# State Test Data (Current)
test_current <- read_csv("https://raw.githubusercontent.com/COVID19Tracking/covid-tracking-data/master/data/states_current.csv") %>% 
  clean_names()

# State Test Data (Dailies)
test_daily <- read_csv("https://raw.githubusercontent.com/COVID19Tracking/covid-tracking-data/master/data/states_daily_4pm_et.csv") %>% 
  # clean_names() %>% 
  filter(state=="TX") %>%
  mutate(date=as.character(date)) %>%
  mutate(date=str_replace(date,"(\\d{4})(\\d{2})(\\d{2})$","\\1-\\2-\\3")) %>% 
  mutate(date = ymd(date))

```


## Test Positive Analysis

```{r}

test_positive <- test_daily %>% 
  filter(date >= as.Date("2020-03-17")) %>% 
  arrange(date) %>% 
  select(date, state, positive, totalTestResults, positiveIncrease, negativeIncrease,  totalTestResultsIncrease) %>% 
  mutate(daily_test_pos_rate = round(positiveIncrease/totalTestResultsIncrease, digits=4),
         daily_test_pos_rate_7day_avg = rollmean(daily_test_pos_rate, 5, 
                                                 fill=0, align = "right"),
         test_pos_label = daily_test_pos_rate,
         test_pos_7day_label = daily_test_pos_rate_7day_avg) %>% 
  mutate_at(vars(test_pos_label,test_pos_7day_label),scales::percent_format(accuracy = .11, scale=100)) %>% 
  rename(`Positive`=positiveIncrease,`Negative`=negativeIncrease) %>% 
  gather(increase_type,increase,5:6)

today <- format(Sys.Date(),format="%B %d, %Y")

test_positive %>% 
  ggplot(aes(x=date,y=increase,fill=increase_type)) +
  geom_col(position="stack") +
  theme_2036() +
  theme(legend.position ="top",
        legend.title = element_text(family="Montserrat-Bold")) +
  scale_fill_manual(values = c("#8C8F93", "#F26852"),
                    guide = guide_legend(keywidth = 1,
                                         keyheight = 2,
                                         label.position = "left",
                                         title.position = "left")) +
  scale_y_continuous(labels = scales::comma, breaks=c(5000,10000,15000)) +
  scale_x_date(breaks = seq(as.Date("2020-03-17"), as.Date("2020-04-22"), by="7 days"), date_labels = "%b %d", expand=c(0,0)) +
  labs(title="Daily New Tests for Texas, by Result",
       subtitle=paste0("<span style='color: #2d2d2d'>From March 17 to ",today,"</span> <span style='color: #8C8F93'>"),
       y="Daily New Test Totals, by Result",
       x="Date Reported",
       fill="Result",
       caption="SOURCE: COVID Tracking Project\nDATA: Texas Department of State Health Services") +
    ggsave(paste0("test_increase_type_",today,".png"), device="png", width=10, height=6.5, dpi=300)

theme_2036_leg <- function(base_size=14,base_family="Montserrat",title_size=23, subtitle_size=12, caption_size=10, ...) {
  ggplot2::theme_minimal(base_size = base_size,base_family = base_family,...) +
  ggplot2::theme(plot.title = ggtext::element_markdown(size = title_size, color= "#3A4A9F",family = "Montserrat-ExtraBold"),
                   plot.subtitle = ggtext::element_markdown(size = subtitle_size, family = "Montserrat"),
                   plot.caption = ggplot2::element_text(family="Montserrat-Regular", color="#8C8F93",size=caption_size, lineheight = 1, hjust = 0, vjust=-5),
                   axis.title.x = ggplot2::element_text(family="Montserrat-Bold", size=8, color="#6B6D6F"),
                   axis.title.y = ggplot2::element_text(family="Montserrat-Bold", size=8, color="#6B6D6F"),
                   legend.position = "top",
                   plot.margin = ggplot2::unit(c(t=1, r=1.5, b=2, l=1), "lines")
    ) +
  ggplot2::theme(axis.line.x =  ggplot2::element_line(color="#5d5d5d", size=.8),
              panel.grid.major.y = ggplot2::element_line(color="#e3e3e3"),
              panel.grid.minor.y = ggplot2::element_line(linetype=2, size=0, color="#e3e3e3"),
              panel.grid.major.x = ggplot2::element_blank(),
              panel.grid.minor.x = ggplot2::element_blank(),
              axis.title.x = ggplot2::element_text(hjust=1),
              axis.title.y = ggplot2::element_text(hjust=1),
              axis.ticks.x = ggplot2::element_line(size = .5))
}

test_positive %>% 
  filter(increase_type=="Positive") %>% 
  mutate(color=case_when(
    daily_test_pos_rate >=.1 ~ "Above 10%",
    TRUE ~ "Below 10%"
  ))  %>% 
  ggplot(aes(x=date,y=daily_test_pos_rate)) +
  geom_hline(yintercept = .1,color="#00A9C5",size=1,alpha=.5,linetype=2)  +
  geom_point(aes(color=color), alpha=.5, size=3) +
  geom_smooth(method="loess", se = FALSE, color="#F26852", linetype=1) +
  theme_2036() +
  theme(legend.position =c(.9,.91)) +
  scale_y_continuous(labels = scales::percent_format(accuracy=1), breaks=c(0,.05,.1,.15,.2,.25,.3,.35), limits=c(0,.35)) +
  scale_color_manual(values=c("#F26852","#002D74"), 
                     guide=guide_legend(direction="vertical",label.position = "left")) +
  scale_x_date(breaks = seq(as.Date("2020-03-17"), as.Date("2020-04-24"), by="7 days"), date_labels = "%b %d", expand=c(0,0)) +
  labs(title="Daily Positive Test Rate for Texas",
       subtitle=paste0("<span style='color: #2d2d2d'>From March 17 to ",today,"</span> | <span style='color: #F26852'> **-------- Moving Average**</span>"),
       y="Daily Positive Test Rate",
       x="Date Reported",
       color=NULL,
       caption="SOURCE: COVID Tracking Project\nDATA: Texas Department of State Health Services\nNOTE: Mar 29 Observation hidden from view, but still factored into moving average.") +
    ggsave(paste0("test_positive_rate_",today,".png"), device="png", width=10, height=6.5, dpi=300)
```


## IHME Projections

```{r}

ihme_mar25 <- read_csv("data/ihme/2020_03_25/ihme-covid19_all_locs.csv") %>% 
  select(state=location_name, date=date_reported, 
         deaths_mean, deaths_lower, deaths_upper, 
         totdea_mean, totdea_lower, totdea_upper) %>% 
  filter(state=="Texas") %>% 
  mutate(proj_date="Mar 25th Projection")

ihme_mar26 <- read_csv("data/ihme/2020_03_26/hospitalization_all_locs_corrected.csv") %>% 
  select(state=location_name, date=date_reported, 
         deaths_mean, deaths_lower, deaths_upper, 
         totdea_mean, totdea_lower, totdea_upper) %>% 
  filter(state=="Texas") %>% 
  mutate(proj_date="Mar 26th Projection")

ihme_mar27 <- read_csv("data/ihme/2020_03_27/hospitalization_all_locs_corrected.csv") %>% 
  select(state=location_name, date=date_reported, 
         deaths_mean, deaths_lower, deaths_upper, 
         totdea_mean, totdea_lower, totdea_upper) %>% 
  filter(state=="Texas") %>% 
  mutate(proj_date="Mar 27th Projection")

ihme_mar29 <- read_csv("data/ihme/2020_03_29/hospitalization_all_locs_corrected.csv") %>% 
  select(state=location_name, date=date_reported, 
         deaths_mean, deaths_lower, deaths_upper, 
         totdea_mean, totdea_lower, totdea_upper) %>% 
  filter(state=="Texas") %>% 
  mutate(proj_date="Mar 29th Projection")


ihme_mar30 <- read_csv("data/ihme/2020_03_30/Hospitalization_all_locs.csv") %>% 
  select(state=location_name, date, 
         deaths_mean, deaths_lower, deaths_upper, 
         totdea_mean, totdea_lower, totdea_upper) %>% 
  filter(state=="Texas") %>% 
  mutate(proj_date="Mar 30th Projection")

ihme_mar31 <- read_csv("data/ihme/2020_03_31.1/Hospitalization_all_locs.csv") %>% 
  select(state=location_name, date, 
         deaths_mean, deaths_lower, deaths_upper, 
         totdea_mean, totdea_lower, totdea_upper) %>% 
  filter(state=="Texas") %>% 
  mutate(proj_date="Mar 31st Projection")

ihme_apr01 <- read_csv("data/ihme/2020_04_01.2/Hospitalization_all_locs.csv") %>% 
  select(state=location_name, date, 
         deaths_mean, deaths_lower, deaths_upper, 
         totdea_mean, totdea_lower, totdea_upper) %>% 
  filter(state=="Texas") %>% 
  mutate(proj_date="Apr 1st Projection")

ihme_apr05 <- read_csv("data/ihme/2020_04_05/Hospitalization_all_locs.csv") %>% 
  select(state=location_name, date, 
         deaths_mean, deaths_lower, deaths_upper, 
         totdea_mean, totdea_lower, totdea_upper) %>% 
  filter(state=="Texas") %>% 
  mutate(proj_date="Apr 5th Projection")

ihme_apr09 <- read_csv("data/ihme/2020_04_09/Hospitalization_all_locs.csv") %>% 
  select(state=location_name, date, 
         deaths_mean, deaths_lower, deaths_upper, 
         totdea_mean, totdea_lower, totdea_upper) %>% 
  filter(state=="Texas") %>% 
  mutate(proj_date="Apr 9th Projection")

ihme_projs_all <-  bind_rows(ihme_mar25,ihme_mar26,ihme_mar27,ihme_mar29,
                             ihme_mar30,ihme_mar30,ihme_mar31,ihme_apr01,
                             ihme_apr05,ihme_apr09)

write_csv(ihme_projs_all,"data/ihme/ihme_all_projections.csv")

# rm(ihme_mar25,ihme_mar26,ihme_mar27,ihme_mar29,
#    ihme_mar30,ihme_mar30,ihme_mar31,ihme_apr01,
#    ihme_apr05,ihme_apr09)
  

```


## DSHS State Data

### Case Related Data

```{r}
today <- Sys.Date()

src <- "https://www.dshs.state.tx.us/coronavirus/TexasCOVID19CaseCountData.xlsx" # Read URL
lcl <- basename(src)
download.file(url = src, destfile = lcl)

dshs_state_case_and_fatalities <- read_excel(lcl, sheet = "Case and Fatalities", skip=1) %>% 
  clean_names() %>% 
  filter(!is.na(county))

write_csv(dshs_state_case_and_fatalities,paste0("clean_data/dshs/cases/state_cases_and_fatalities_",today,".csv"))
write_csv(dshs_state_case_and_fatalities,paste0("clean_data/dshs/cases/state_cases_and_fatalities.csv"))

  
dshs_state_recover <- read_excel(lcl, sheet="Recoveries", skip=1) %>% 
  clean_names() %>% 
  slice(1) %>%
  rename(recoveries=1) %>% 
  mutate(recoveries=as.numeric(recoveries),
         state="Texas",
         fips="48")

write_csv(dshs_state_recover,paste0("clean_data/dshs/cases/state_recovered_",today,".csv"))
write_csv(dshs_state_recover,paste0("clean_data/dshs/cases/state_recovered.csv"))


dshs_state_tests <- read_excel(lcl, sheet="Tests", skip=1) %>% 
  clean_names() %>% 
  filter(!is.na(count)) %>% 
    mutate(tests=as.numeric(count ),
           state="Texas",
           fips="48",
           test_type=case_when(
             str_detect(location,"Public") ~ "Public",
             TRUE ~ "Private"
           )) %>% 
  select(state,fips,test_type,tests) 

write_csv(dshs_state_tests,paste0("clean_data/dshs/testing/state_tests_",today,".csv"))
write_csv(dshs_state_tests,paste0("clean_data/dshs/testing/state_tests.csv"))

# dshs_state_hospitalizations <- read_excel(lcl, sheet="Hospitalizations", skip=0) %>% 
#   clean_names() %>% 
#   mutate(ind = rep(c(1, 2),length.out = n())) %>%
#   rename(text=1) %>% 
#   group_by(ind) %>%
#   mutate(id = row_number()) %>%
#   spread(ind, text) %>%
#   select(hosp_data=2, value=3,-id) %>% 
#   mutate(value=as.numeric(value),
#          state="Texas",
#          fips="48")

dshs_state_hospitalizations <- read_excel(lcl, sheet="Hospitalizations", skip=1) %>% 
  clean_names() %>% 
  filter(!is.na(count)) %>% 
  rename(text=1) %>%
  mutate(text=gsub(pattern="Texas ",replacement="",x=text),
         text=gsub(pattern="Available",replacement="Avail",x=text)) %>%
  spread(text,count) %>%
  mutate_all(funs(as.numeric)) %>% 
  clean_names()

 
write_csv(dshs_state_hospitalizations,paste0("clean_data/dshs/hospitals/state_hospitalizations_",today,".csv"))
write_csv(dshs_state_hospitalizations,paste0("clean_data/dshs/hospitals/state_hospitalizations.csv"))


dshs_state_ages <- read_excel(lcl, sheet = "Cases by Age Group", skip=1) %>% 
  clean_names() %>% 
  select(group=age_groupings, cases=number, pct=3) %>% 
  filter(pct<1) %>% 
  mutate(cases=as.numeric(cases),
         report_type="cases",
         pct=as.numeric(pct),
         demographic_type="ages")
  
dshs_state_gender <- read_excel(lcl, sheet="Cases by Gender", skip=1) %>% 
  clean_names() %>% 
  select(group=gender, cases=number, pct=percentage) %>% 
  filter(pct<1) %>% 
  mutate(cases=as.numeric(cases),
         report_type="cases",
         pct=as.numeric(pct),
         demographic_type="gender")

dshs_state_race <- read_excel(lcl, sheet="Cases by RaceEthnicity", skip=1) %>% 
  clean_names() %>% 
  select(group=race_ethnicity, cases=number, pct=percentage) %>% 
  filter(pct<1) %>% 
  mutate(cases=as.numeric(cases),
         report_type="cases",
         pct=as.numeric(pct),
         demographic_type="race")

dshs_state_ages_fates <- read_excel(lcl, sheet = "Fatalities by Age Group", skip=1) %>% 
  clean_names() %>% 
  select(group=age_groupings, cases=number, pct=3) %>% 
  filter(pct<1) %>% 
  mutate(cases=as.numeric(cases),
         report_type="fatalities",
         pct=as.numeric(pct),
         demographic_type="ages")
  
dshs_state_gender_fates <- read_excel(lcl, sheet = "Fatalities by Gender", skip=1) %>% 
  clean_names() %>% 
  select(group=gender, cases=number, pct=percentage) %>% 
  filter(pct<1) %>% 
  mutate(cases=as.numeric(cases),
         report_type="fatalities",
         pct=as.numeric(pct),
         demographic_type="gender")

dshs_state_race_fates <- read_excel(lcl, sheet = "Fatalities by Race-Ethnicity", skip=1) %>% 
  clean_names() %>% 
  select(group=race_ethnicity, cases=number, pct=percentage) %>% 
  filter(pct<1) %>% 
  mutate(cases=as.numeric(cases),
         report_type="fatalities",
         pct=as.numeric(pct),
         demographic_type="race")

dshs_demographic_data <- bind_rows(dshs_state_ages,
                                   dshs_state_gender,
                                   dshs_state_race,
                                   dshs_state_ages_fates,
                                   dshs_state_gender_fates,
                                   dshs_state_race_fates) %>% 
  select(4,5,1,everything())  %>% 
  mutate(state="Texas",
         fips="48") %>% 
  select(state,fips,everything()) %>%
  rename(count=cases)

write_csv(dshs_demographic_data,paste0("clean_data/dshs/cases/state_case_demographics_",today,".csv"))
write_csv(dshs_demographic_data,paste0("clean_data/dshs/cases/state_case_demographics.csv"))

rm(dshs_state_ages, dshs_state_gender,dshs_state_race)

src <- "https://www.dshs.state.tx.us/coronavirus/TexasCOVID19DailyCountyCaseCountData.xlsx"
lcl <- basename(src)
download.file(url = src, destfile = lcl)

dshs_county_data <- read_excel(lcl,skip=2) %>% 
  clean_names() %>% 
  rename_at(vars(matches("^cases_")), funs(gsub(pattern="^cases_", replacement="",x=.))) %>% 
  filter(!is.na(`03_04`))

write_csv(dshs_county_data,paste0("clean_data/dshs/cases/county_cases_",today,".csv"))
write_csv(dshs_county_data,paste0("clean_data/dshs/cases/county_cases.csv"))


```

### County Testing Data

```{r}
src <- "https://www.dshs.state.tx.us/chs/data/COVID-19CumulativeTestTotalsbyCounty.xlsx"
lcl <- basename(src)
download.file(url = src, destfile = lcl)

dshs_county_tests <- read_excel(lcl,skip=1) %>% 
  rename(county_name=1, tests=2) %>%
  slice(1:256) %>% 
  mutate(state="Texas") %>%
  select(state,county_name,total_tests=tests)


write_csv(dshs_county_tests,paste0("clean_data/dshs/testing/county_tests_",today,".csv"))
write_csv(dshs_county_tests,paste0("clean_data/dshs/testing/county_tests.csv"))

```

## Trauma Service Area Data

### Crosswalk & Bed/Vent Report Data

```{r}

crosswalk_data <- read_excel("data/dshs/Crosswalk TX Counties RACs PHRs.xlsx", skip=2) %>%
  clean_names() %>% 
  separate(trauma_service_area, into=c("tsa", "tsa_label")) %>% 
  mutate(tsa=paste0("TSA-",tsa)) %>% 
  select(tsa,county,everything()) %>%
  left_join(tx_counties, by="county") %>% 
  group_by(tsa) %>% 
  summarise(tsa_counties = toString(county),
            geometry = st_union(geometry))

  tsa_data <- read_excel("data/dshs/TSA COVID Bed Reports_04.28.20.xlsx", 
                       sheet = "Bed Availability",
                       skip=0) %>%
  clean_names() %>% 
  filter(!is.na(tsa)) %>% 
  left_join(crosswalk_data, by="tsa") %>% 
  select(1,2,tsa_counties,everything()) %>% 
  separate_rows(tsa_counties, sep=",") %>%
  mutate(tsa_counties=str_trim(tsa_counties, side="both")) %>% 
  st_as_sf()


tsa_data_vents <- read_excel("data/dshs/TSA COVID Bed Reports_04.28.20.xlsx", 
                       sheet = "Vent Availability",
                       skip=0) %>%
  clean_names() %>% 
  filter(!is.na(tsa)) %>% 
  left_join(crosswalk_data, by="tsa") %>% 
  select(1,2,tsa_counties,everything()) %>% 
  separate_rows(tsa_counties, sep=",") %>%
  mutate(tsa_counties=str_trim(tsa_counties, side="both")) %>% 
  st_as_sf()

  #Write Current & Timestamped CSVs of Bed/Vent Data
  write_csv(tsa_data,"clean_data/dshs/hospitals/tsa_vent_data_with_counties_sf.csv")
  write_csv(tsa_data_vents,"clean_data/dshs/hospitals/tsa_bed_data_with_counties_sf.csv")
  write_csv(tsa_data,paste0("clean_data/dshs/hospitals/tsa_bed_data_with_counties_sf_",today,".csv"))
  write_csv(tsa_data_vents,paste0("clean_data/dshs/hospitals/tsa_vent_data_with_counties_sf_",today,".csv"))
  
  #Write Current & Timestamped RDS files of Bed/Vent Data
  write_rds(tsa_data,"clean_data/dshs/hospitals/tsa_bed_data_with_counties_sf.rds")
  write_rds(tsa_data_vents,"clean_data/dshs/hospitals/tsa_vent_data_with_counties_sf.rds")
  write_rds(tsa_data,paste0("clean_data/dshs/hospitals/tsa_bed_data_with_counties_sf_",today,".rds"))
  write_rds(tsa_data_vents,paste0("clean_data/dshs/hospitals/tsa_vent_data_with_counties_sf_",today,".rds"))


```

### Syndromic Data

```{r}

syndromic_tx <- read_excel("data/dshs/TxS2 Chart April 30 Dashboard.xlsx", sheet="Texas", skip=0) %>%
  clean_names() %>% 
  mutate(date = ymd(date)) %>% 
  write_csv("clean_data/dshs/syndromic_tx.csv")

syndromic_cli <- read_excel("data/dshs/TxS2 Chart April 30 Dashboard.xlsx", sheet="CLI Data", skip=0) %>%
  clean_names() %>% 
  mutate(date = ymd(date)) %>% 
  write_csv("clean_data/dshs/syndromic_cli.csv")

syndromic_ili <- read_excel("data/dshs/TxS2 Chart April 30 Dashboard.xlsx", sheet="ILI Data", skip=0) %>%
  clean_names() %>% 
  mutate(date = ymd(date)) %>% 
  write_csv("clean_data/dshs/syndromic_ili.csv")

```


## NYT Time Series Data

```{r}

ts_state_cases <- read_csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv")

ts_county_cases <- read_csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv")

```

### NYT Highchart County Map

```{r, nyt county data}

sf_counties <- tidycensus::county_laea
ts_county_cases_sf <- ts_county_cases %>% 
  filter(date=="2020-03-27",
         state=="Texas") %>% 
  left_join(sf_counties, by=c("fips"="GEOID")) %>% 
  sf::st_as_sf()

mapdata <- get_data_from_map(download_map_data("countries/us/us-tx-all"))

tx_county_cases <- ts_county_cases %>% 
  filter(date=="2020-03-27",
         state=="Texas")

tx_county_data <- mapdata %>% 
  left_join(tx_county_cases, by="fips")

hcmap("countries/us/us-tx-all", data = tx_county_data, value = "cases",
      joinBy = "fips", name = "COVID-19 Confirmed Cases",
      dataLabels = list(enabled = FALSE, format = '*{name}*'),
      borderColor = "#FAFAFA", borderWidth = 0.1,
      tooltip = list(valueDecimals = 0, fontSize="18px",valuePrefix = "", valueSuffix = " Cases")) %>%
  hc_title(text = "Texas COVID-19 Cases", style = list(fontFamily = "Montserrat", fontSize = "28px", 
                                                       fontWeight="bold", textTransform="uppercase")) %>% 
  hc_add_theme(
          hc_theme_merge(
            hc_theme_tufte(),
            hc_theme(chart = list(
              # styledMode=TRUE,
              # backgroundColor = "#f4f7fb",
              style = list(fontFamily = "Montserrat", fontSize = "28px", fontWeight="700"))))) 
  highcharter::

ts_county_cases_sf %>% 
  ggplot() +
  geom_sf(data=sf_counties %>% filter(str_detect(GEOID,"48")),color="#dddddd", fill="#f2f2f2", lwd=.3) +
  geom_sf(aes(fill=cases), lwd=.3) +
  scale_fill_gradientn(colours = tinter(hex, steps = 5), labels = function(x) paste0(x,"Cases")) +
  coord_sf(datum=NA) +
  labs(title="Confirmed COVID-19 Cases By County - Texas",
       subtitle="As of March 26th, 2020",
       caption="SOURCE: New York Times COVID-19 Database") +
  theme_2036() +
  ggsave("current_cases_by_county.png", device="png",width=15, height =10)
```

### NYT State and County Curves

```{r, nyt state and county data}
ts_state_cases %>%
  # filter(state!="New York") %>% 
  ggplot(aes(x=date,y=cases)) +
  geom_area(fill="red", color="red") +
  # gghighlight(state=="Texas") +
  theme_2036() +
  facet_geo(~state) +
  labs(title="Confirmed COVID-19 Cases By State",
       caption="SOURCE: New York Times COVID-19 Database") +
  ggsave("ts_cases_by_state.png", device="png",width=15, height =10)


ts_county_cases %>%
  filter(state=="Texas") %>%
  ggplot(aes(x=date,y=cases, color=county)) +
  geom_line(size=.8) +
  scale_color_grey() +
  theme_2036() +
  labs(title="Confirmed COVID-19 Texas Cases, By County",
       caption="SOURCE: New York Times COVID-19 Database") +
  ggsave("ts_TXcases_by_county.png", device="png",width=10, height=6)

```
# NPI Datasets

## Google Mobility Reports Data

```{r}
google_mobility <- read_csv("https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv") %>% 
  filter(sub_region_1=="Texas")

```

# Derived Metrics

```{r}

src <- "https://www.dshs.state.tx.us/coronavirus/COVID-19CumulativeTestTotalsbyCounty.xlsx"
lcl <- basename(src)
download.file(url = src, destfile = lcl)

dshs_county_test_data <- read_excel(lcl,skip=1)  %>% 
  rename(county_name=1, tests=2) %>% 
  drop_na(tests)


dshs_tsa_hospital_data <- read_excel("data/dshs/Copy of TSA COVID Bed Reports_04.19.20.xlsx") %>%
  rename(tsa = 1,
         adult_icu = 3,
         confirmed_cases = 20) %>%
  mutate(tsa_clean = substring(tsa, 5))

## ** Crosswalk Data ----

crosswalk_data <- read_excel("data/dshs/Crosswalk TX Counties RACs PHRs.xlsx", skip=2) %>%
  rename(
    county_name = 1,
    public_health_region = 2,
    tsa = 3
  ) %>%
  mutate(tsa_clean = substring(tsa, 1, 1))



# ** State -----------------------------------

# Tests Per 100,000

total_population <- state_pop %>%
  clean_names() %>% 
  rename(state=name, total_population=estimate, fips=geoid) %>% 
  filter(state=="Texas")

#SCRATCH THIS AND USE JHU'S TESTING RATE
total_tests <- dshs_state_tests %>%
  group_by(state,fips) %>%
  summarise(total_tests = sum(tests)) %>%
  ungroup() %>%
  left_join(total_population, by=c("state","fips")) %>%
  mutate(tests_per_100k = round(total_tests/total_population,digits=4)*100000)

# Available Ventilators Per COVID-19 Case

available_beds <- dshs_state_hospitalizations %>% 
  filter(hosp_data == "Available Texas Hospital Beds") %>% 
  select(value)

available_beds_icu <- dshs_state_hospitalizations %>% 
                        filter(hosp_data == "Available Texas ICU Beds") %>% 
  select(value)

available_ventilators = dshs_state_hospitalizations %>% 
                           filter(hosp_data == "Available Texas Ventilators") %>% 
  select(value)

total_cases = (jhu_cases_state %>% select(confirmed))$confirmed

print("Available Ventilators Per COVID-19 Case")
print((available_ventilators / total_cases))

# Available ICU Beds Per COVID-19 Case

print("Available ICU Beds Per COVID-19 Case")
print((available_beds_icu / total_cases))

# Case Growth Rate

daily_growth_rates <- nyt_state_cases %>%
  arrange(date) %>%
  mutate(daily_growth_rate = (cases / lag(cases))) %>%
  mutate(daily_growth_rate_7day_avg = rollmean(daily_growth_rate, 7, fill =
                                                 0, align = "right"))

print("Daily Growth Rates")
print(daily_growth_rates %>% arrange(desc(date)))

# Doubling Every X days

## Get total cases today, find the date that was half of that
today = ((nyt_state_cases %>% arrange(desc(date)))[1, 1])$date
cases_today = ((nyt_state_cases %>% arrange(desc(date)))[1, 4])$cases

last_half_day = ((nyt_state_cases %>% arrange(desc(date)) %>% filter(cases < (cases_today / 2)))[1, 1])$date

print("Doubling every X days")
print(today - last_half_day)


# 1 and 7-day rates of change for cumulative cases, daily new cases, daily new deaths, and daily new hospitalized


rates_of_change = nyt_state_cases %>%
  arrange(date) %>%
  mutate(
    new_cases = case_when(
      is.na(cases - lag(cases)) ~ 0,
      TRUE ~ cases - lag(cases)
    ),
    new_deaths = case_when(
      is.na(deaths - lag(deaths)) ~ 0,
      TRUE ~ deaths - lag(deaths)
    )
  ) %>% 
  mutate(
    new_cases_7day_avg = rollmean(new_cases, 7, fill=0, align="right"),
    new_deaths_7day_avg = rollmean(new_deaths, 7, fill=0, align="right")
  )

print("Rates of Change.")
print(rates_of_change %>% arrange(desc(date)))

# Positive/Negative Testing. Current and TS.

# 
#  ** County ----------
# 

# Crosswalk the NCHS and Trauma Service Area Data.

county_tsa_data  = merge(crosswalk_data, dshs_tsa_hospital_data, by="tsa_clean")

print("Crosswalk county hospital data.")
print(county_tsa_data)

# Integrate DSHS Tests Per County Data

dshs_county_data = merge(dshs_county_data, dshs_county_test_data, by="county_name")
dshs_county_data = merge(dshs_county_data, dshs_state_case_and_fatalities, by="county_name")
dshs_county_data = merge(dshs_county_data, county_tsa_data, by="county_name")

# Tests Per 100,000

tests_per_100k_counties = 100000 * dshs_county_data$tests / dshs_county_data$population

print(tests_per_100k_counties)

# Available Ventilators Per COVID-19 Case

dshs_county_data = dshs_county_data %>%
  mutate(
    ventilators_per_case = adult_icu / confirmed_cases
  )

print("Available Ventilators Per COVID-19 Case (Calculated at TSA level)")
print(dshs_county_data %>% select("county_name", "ventilators_per_case"))


# Available ICU Beds Per COVID-19 Case

dshs_county_data = dshs_county_data %>%
  mutate(
    icu_beds_per_case = adult_icu / confirmed_cases
  )

print("Available ICU Beds COVID-19 Case (Calculated at TSA level)")
print(dshs_county_data %>% select("county_name", "icu_beds_per_case"))

# Case Growth Rate

daily_county_growth_rates = nyt_county_cases %>%
  group_by(county) %>%
  arrange(date) %>%
  mutate(
    daily_growth_rate = case_when(
      is.na(cases / lag(cases)) ~ 0,
      TRUE ~ cases / lag(cases)
    )
  ) %>%
  mutate(
    daily_growth_rate_7day_avg = rollmean(daily_growth_rate, 7, fill=0, align="right")
  )

print("County growth rate, e.g. Austin County:")
print(daily_county_growth_rates %>% filter(county=="Austin") %>% arrange(desc(date)))

# Doubling Every X days

# 1 and 7-day rates of change for cumulative cases, daily new cases, daily new deaths, and daily new hospitalized

county_rates_of_change = nyt_county_cases %>%
  group_by(county) %>%
  arrange(date) %>%
  mutate(
    new_cases = case_when(
      is.na(cases - lag(cases)) ~ 0,
      TRUE ~ cases - lag(cases)
    ),
    new_deaths = case_when(
      is.na(deaths - lag(deaths)) ~ 0,
      TRUE ~ deaths - lag(deaths)
    )
  ) %>% 
  mutate(
    new_cases_7day_avg = rollmean(new_cases, 7, fill=0, align="right"),
    new_deaths_7day_avg = rollmean(new_deaths, 7, fill=0, align="right")
  )

print("County rates of Change.")
print(county_rates_of_change %>% arrange(desc(date)))


# Positive/Negative Testing. Current and TS. (If we can get comprehensive data on testing at the county level. To my knowledge, COVID-tracking only produces this at a statewide-level).
# 
```

# Economic Data

## TWC Weekly Claims Data, By County & Industry

```{r}
src <- "https://www.twc.texas.gov/files/agency/weekly-claims-by-county-twc.xlsx" # Read URL
today <- Sys.Date()

lcl <- basename(src)
download.file(url = src, destfile = paste0("data/twc/",today,"_", lcl))


twc_claims_cnty <- read_excel(lcl, skip=2) %>%
  slice(1:254) %>% 
  clean_names() %>% 
  filter(!is.na(county)) %>% 
  remove_empty("cols") %>% 
  # select_at(vars(county, ends_with("2020"))) %>% 
  pivot_longer(-county, names_to = "date", values_to = "value") %>% 
  mutate(date=gsub("^x","0",x=date),
         date=gsub("_","-",x=date)) %>% 
  mutate(date=lubridate::mdy(date))

twc_claims_cnty %>% 
  # group_by(state) %>% 
  filter(date == max(date)) %>% 
  left_join(tx_counties, by="county") %>% 
  st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill=value)) +
  theme_2036()


src <- "https://www.twc.texas.gov/files/agency/claims-industry-twc.xlsx" # Read URL
lcl <- basename(src)
download.file(url = src, destfile = paste0("data/twc/", lcl))

twc_claims_ind <- read_excel(lcl, skip=1) %>% 
  clean_names()
```

## Homebase Data

```{r}
hb_summary <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vS6_JK5zktVQr6JwkYUPvzlwcw0YAawSVC7ldWZVfg9hvTjBxl2z4xWaWCrzb9JZ0Go07KhLgbzw5DW/pub?gid=1178059516&single=true&output=csv", skip=2) %>% 
  select(-1,-2) %>% 
  rename(summ_group = 1) %>% 
  filter(!is.na(summ_group),
         !is.na(`4/1`))

hb_hours_worked <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vS6_JK5zktVQr6JwkYUPvzlwcw0YAawSVC7ldWZVfg9hvTjBxl2z4xWaWCrzb9JZ0Go07KhLgbzw5DW/pub?gid=1930671010&single=true&output=csv", skip=2) %>% 
  fill(X2) %>% 
  slice(-1,-3,-4) %>% 
  select(-1) %>% 
  mutate(geo_type=case_when(
    str_detect(X2, "MSA") ~ "MSA",
    str_detect(X2, "industry") ~ "US Industry",
    str_detect(X2, "state") ~ "State",
    TRUE ~ "Nationwide"
  )) %>% 
  select(geo_type, area=X3,everything(),-X2) %>% 
  filter(!is.na(area))

hb_businesses_open <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vS6_JK5zktVQr6JwkYUPvzlwcw0YAawSVC7ldWZVfg9hvTjBxl2z4xWaWCrzb9JZ0Go07KhLgbzw5DW/pub?gid=1102464531&single=true&output=csv", skip=2) %>% 
  fill(X2) %>% 
  slice(-1,-3,-4) %>% 
  select(-1) %>% 
  mutate(geo_type=case_when(
    str_detect(X2, "MSA") ~ "MSA",
    str_detect(X2, "industry") ~ "US Industry",
    str_detect(X2, "state") ~ "State",
    TRUE ~ "Nationwide"
  )) %>% 
  select(geo_type, area=X3,everything(),-X2) %>% 
  filter(!is.na(area))

hb_employees_working <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vS6_JK5zktVQr6JwkYUPvzlwcw0YAawSVC7ldWZVfg9hvTjBxl2z4xWaWCrzb9JZ0Go07KhLgbzw5DW/pub?gid=1658358543&single=true&output=csv", skip=2) %>% 
  fill(X2) %>% 
  slice(-1,-3,-4) %>% 
  select(-1) %>% 
  mutate(geo_type=case_when(
    str_detect(X2, "MSA") ~ "MSA",
    str_detect(X2, "industry") ~ "US Industry",
    str_detect(X2, "state") ~ "State",
    TRUE ~ "Nationwide"
  )) %>% 
  select(geo_type, area=X3,everything(),-X2) %>% 
  filter(!is.na(area))
```

### NYT ggplot2 State Chart
```{r, nyt state data}


sf_states <- tidycensus::state_laea 

ts_state_cases_sf <- ts_state_cases %>% 
  filter(date=="2020-03-26") %>% 
  left_join(sf_states, by=c("fips"="GEOID")) %>% 
  sf::st_as_sf()

hex <- "#2171b5"

ts_state_cases_sf %>% 
  ggplot() +
  geom_sf(aes(fill=cases)) +
  scale_fill_gradientn(colours = tinter(hex, steps = 5), labels = function(x) paste0(x,"Cases")) +
  # coord_sf(datum=NA) +
  labs(title="Confirmed COVID-19 Cases By State",
       subtitle="As of March 26th, 2020",
       caption="SOURCE: New York Times COVID-19 Database") +
  theme_2036() +
  ggsave("current_cases_by_state.png", device="png",width=15, height =10)
```


## FREDr Data

### 

```{r}

tx_series_all <-fredr(
  series_id = "TXICLAIMS",
  observation_start = as.Date("2020-01-01")
) %>% 
  mutate(date=as.character(date)) %>%
  add_row(date="2020-04-18", series_id="TXICLAIMS", value=273567) %>%
  add_row(date="2020-04-25", series_id="TXICLAIMS", value=437300) %>%
  mutate(date=as.Date(date)) %>%
  arrange(date) %>% 
  write_rds("clean_data/fredr/ui_claims_ts.rds")



tx_series <- tx_series_all %>%
  filter(date >= as.Date("2020-03-21")) %>% 
  group_by(series_id) %>% 
  summarise(running_claims=sum(value)) %>% 
  rename(value=running_claims) %>% 
  mutate_at(vars(value),scales::comma)

tx_urn <-fredr(
  series_id = "TXURN",
  observation_start = as.Date("2020-01-01")
) %>% 
  mutate(date=as.Date(date)) %>%
  filter(date == max(date)) %>% 
  write_rds("clean_data/fredr/unemploy_rate.rds")
```


#### ggplot2 Graphic

```{r, weekly_unemployment_claims}

# ui_claims <- read_csv("raw_data/TXICLAIMS.csv")

# tx_ui_claims <- read_csv("cleandata/TXICLAIMS.csv") %>% 
#   add_row()

tx_series <-fredr(
  series_id = "TXICLAIMS",
  observation_start = as.Date("2000-01-01")
) %>% 
  mutate(date=as.character(date)) %>%
  add_row(date="2020-04-04", series_id="TXICLAIMS", value=313832) %>% 
  mutate(date=as.Date(date),
         recession=case_when(
         date %>% between(as.Date("2007-12-01"),as.Date("2009-06-01")) ~ "Recession",
         TRUE ~  "Not Recession"
         ),
         harvey=case_when(
         date %>% between(as.Date("2017-08-17"),as.Date("2017-09-02")) ~ "Harvey",
         TRUE ~  "Not Harvey"
         ))

recessions_data <- readxl::read_excel("bcdc1.xlsx") %>% 
  clean_names() %>% 
  filter(peak_month_number > 2287) %>% 
  mutate(peak = case_when(
    peak_month=="July 1990" ~ as.Date("1990-07-01"),
    peak_month=="March 2001" ~ as.Date("2001-03-01"),
    peak_month=="December 2007" ~ as.Date("2007-12-01")
  ),
  trough = case_when(
    trough_month=="March 1991" ~ as.Date("1991-03-01"),
    trough_month=="November 2001" ~ as.Date("2001-11-01"),
    trough_month=="June 2009" ~ as.Date("2009-06-01")
  ))

get_png <- function(filename) {
  grid::rasterGrob(png::readPNG(filename), interpolate = TRUE)
}

l <- get_png("logo_orange.png")

tx_series %>% 
  ggplot() +
  geom_rect(data=recessions_data, aes(xmin=peak, xmax=trough, ymin=0, ymax=313832), fill='grey', alpha=0.4,
            show.legend = TRUE) +
  geom_area(aes(x=date,y=value), position="stack", color="#3A4A9F", fill="#3A4A9F", alpha=.7) +
  geom_mark_rect(data=tx_series, 
                 aes(x=date,y=value, fill = recession, label = "Global Financial Crisis", 
                     description = "Dec 2007 - Jun 2009",filter = recession == 'Recession'),
                 expand = unit(3, "mm"), 
                 fill = "#F26852",
                 label.fontsize = 9,
                 label.family = "Montserrat",
                 con.size = 0.5, 
                 label.buffer = unit(5, "mm"),
                 radius = unit(1.5,"mm")) +
  geom_mark_rect(data=tx_series, 
                 aes(x=date,y=value,label = "Hurricane Harvey", 
                     description = "Aug 1 - Sep 02, 2017",filter = harvey == 'Harvey'),
                 expand = unit(3, "mm"), 
                 fill = "#F26852",
                 label.fontsize = 9,
                 label.family = "Montserrat",
                 con.size = 0.5, 
                 label.buffer = unit(5, "mm"),
                 radius = unit(1.5,"mm")) +
  annotate("text",
           x = as.Date("2017-09-17"),
           y = 265597,
           label = "COVID-19 Pandemic",
           family = "Montserrat-Bold", color = "#2d2d2d", size=4) +
  annotate("text",
           x = as.Date("2016-8-21"),
           y = 254597,
           label = "March 2020",
           family = "Montserrat-Regular", size=3, color = "#2d2d2d") +
  annotate("segment",
           x = as.Date("2018-11-01"),
           xend = as.Date("2020-3-01"),
           y = 270597,
           yend = 313832,
           size=.5, 
           color = "black", 
           arrow=arrow(length = unit(0.09, "inches"), type="closed")) +
  # scale_x_date(date_breaks = "5 year",date_labels = "%Y") +
  theme_2036() +
  theme(plot.caption=element_text(size=8)) +
  scale_y_continuous(labels = scales::comma, breaks=c(50000,100000,150000,200000,250000,300000)) +
  labs(title="TEXAS INITIAL WEEKLY JOBLESS CLAIMS",
       subtitle="<span style='color: #2d2d2d'>As of the week ending on April 4, 2020</span> <span style='color: #8C8F93'>**| Shaded Areas Indicate U.S. Recessions**</span> ",
       y="Non-Adjusted Weekly Claims",
       x="Date",
       caption="SOURCE: United States Department of Labor\nDATA: Federal Reserve Bank of St. Louis Economic Research\nNOTE: Recession dates are sourced from the National Bureau of Economic Research") +
  annotation_custom(grob = linesGrob(gp = gpar(col = "#8C8F93")), xmin = 1998, xmax = 2022, ymin = -10000, ymax = -10000) +
  annotation_custom(l, xmin = as.Date("2018-01-01"), xmax = as.Date("2021-01-01"), ymin = -85000, ymax = -35000) +
  coord_cartesian(clip = "off") +
  ggsave("jobless_claims_chart_ABBRV_YEARS.png", device="png", width=11, height=6.5, dpi=300)

```

```{r, weekly_unemployment_claims for 2020}

# ui_claims <- read_csv("raw_data/TXICLAIMS.csv")

# tx_ui_claims <- read_csv("cleandata/TXICLAIMS.csv") %>% 
#   add_row()

tx_series <-fredr(
  series_id = "TXICLAIMS",
  observation_start = as.Date("2000-01-01")
) %>% 
  mutate(date=as.character(date)) %>%
  add_row(date="2020-04-04", series_id="TXICLAIMS", value=313832) %>% 
  mutate(date=as.Date(date),
         recession=case_when(
         date %>% between(as.Date("2007-12-01"),as.Date("2009-06-01")) ~ "Recession",
         TRUE ~  "Not Recession"
         ),
         harvey=case_when(
         date %>% between(as.Date("2017-08-17"),as.Date("2017-09-02")) ~ "Harvey",
         TRUE ~  "Not Harvey"
         ))

recessions_data <- readxl::read_excel("bcdc1.xlsx") %>% 
  clean_names() %>% 
  filter(peak_month_number > 2287) %>% 
  mutate(peak = case_when(
    peak_month=="July 1990" ~ as.Date("1990-07-01"),
    peak_month=="March 2001" ~ as.Date("2001-03-01"),
    peak_month=="December 2007" ~ as.Date("2007-12-01")
  ),
  trough = case_when(
    trough_month=="March 1991" ~ as.Date("1991-03-01"),
    trough_month=="November 2001" ~ as.Date("2001-11-01"),
    trough_month=="June 2009" ~ as.Date("2009-06-01")
  ))

get_png <- function(filename) {
  grid::rasterGrob(png::readPNG(filename), interpolate = TRUE)
}

l <- get_png("logo_orange.png")

tx_series %>% 
  filter(date >= as.Date("2019-12-31")) %>% 
  ggplot() +
  geom_col(aes(x=date,y=value), position="stack", color="#3A4A9F", fill="#3A4A9F", alpha=.8) +
  geom_text(aes(x=date,y=value, label=scales::comma(value, scale=.001, accuracy=1,suffix="k+")), 
            family = "Montserrat-Bold", color = "gray40",nudge_y=6000, size = 3) +
  theme_2036() +
  theme(plot.caption=element_text(size=8),
        axis.text.x = element_text(angle = 90, size=8)) +
  scale_y_continuous(labels = scales::comma, breaks=c(50000,100000,150000,200000,250000,300000)) +
  scale_x_date(breaks = seq(as.Date("2019-12-28"), as.Date("2020-04-08"), by="7 days"), date_labels = "%b %d", expand=c(0,0)) +
  labs(title="TEXAS INITIAL WEEKLY JOBLESS CLAIMS",
       subtitle="<span style='color: #2d2d2d'>As of the week ending on April 4, 2020</span> <span style='color: #8C8F93'>",
       y="Non-Adjusted Weekly Claims",
       x="Filing Date",
       caption="SOURCE: United States Department of Labor\nDATA: Federal Reserve Bank of St. Louis Economic Research") +
  annotation_custom(grob = linesGrob(gp = gpar(col = "#8C8F93")), xmin = 1998, xmax = 2022, ymin = -10000, ymax = -10000) +
  annotation_custom(l, xmin = as.Date("2018-01-01"), xmax = as.Date("2021-01-01"), ymin = -85000, ymax = -35000) +
  coord_cartesian(clip = "off") +
  ggsave("jobless_claims_chart_2020.png", device="png", width=10, height=6.5, dpi=300)

```

## Population-Related and Other Data

```{r}

src <- "https://www.cdc.gov/nchs/data/data_acces_files/NCHSURCodes2013.xlsx" # Read URL
lcl <- basename(src)
download.file(url = src, destfile = lcl)

nchs_urbanization_codes <- read_excel(lcl, skip=0) %>% 
  clean_names() %>% 
  mutate(nchs_code_2013 = case_when(
    x2013_code==1 ~ "Large central metro",
    x2013_code==2 ~ "Large fringe metro",
    x2013_code==3 ~ "Medium metro",
    x2013_code==4 ~ "Small metro",
    x2013_code==5 ~ "Micropolitan",
    x2013_code==6 ~ "Noncore"
  ))
```

# Regression Analysis Queries